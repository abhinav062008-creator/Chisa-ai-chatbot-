<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chisa Â· Wuthering Waves AI</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="ocean-bg">
        <div class="wave wave1"></div>
        <div class="wave wave2"></div>
        <div class="wave wave3"></div>
    </div>

    <div class="container">
        <!-- Header -->
        <header>
            <div class="logo">
                <i class="fas fa-water"></i>
                <span>Chisa Â· Wuthering Waves</span>
            </div>
            <button id="resetBtn" class="reset-btn">
                <i class="fas fa-undo-alt"></i> New Wave
            </button>
        </header>

        <!-- Main Chat Area -->
        <div class="chat-interface">
            <!-- Left Side - Avatar -->
            <div class="avatar-section">
                <div class="avatar-container">
                    <div class="avatar-glow" id="avatarGlow"></div>
                    <div class="avatar-frame" id="avatarFrame">
                        <!-- Avatar SVG will be injected here by JS -->
                        <div id="avatarDisplay"></div>
                    </div>
                    
                    <!-- Emotion Indicator -->
                    <div class="emotion-badge" id="emotionBadge">
                        <i class="fas fa-smile"></i>
                        <span id="emotionText">happy</span>
                    </div>
                    
                    <!-- Speaking Animation -->
                    <div class="speaking-indicator" id="speakingIndicator">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                    
                    <!-- Voice Status -->
                    <div class="voice-status" id="voiceStatus">
                        <i class="fas fa-volume-up"></i>
                        <span>Voice Active</span>
                    </div>
                </div>
                
                <!-- Avatar Controls -->
                <div class="avatar-controls">
                    <button class="control-btn" id="toggleVoiceBtn" title="Toggle Voice">
                        <i class="fas fa-volume-mute"></i>
                    </button>
                    <button class="control-btn" id="waveHandBtn" title="Wave">
                        <i class="fas fa-hand-peace"></i>
                    </button>
                    <button class="control-btn" id="emoteBtn" title="Change Emotion">
                        <i class="fas fa-heart"></i>
                    </button>
                </div>
            </div>

            <!-- Right Side - Chat -->
            <div class="chat-section">
                <div class="messages-container" id="messagesContainer">
                    <!-- Welcome message -->
                    <div class="message chisa">
                        <div class="avatar-icon">
                            <i class="fas fa-ghost"></i>
                        </div>
                        <div class="bubble">
                            ðŸŒŠ The tides brought you to me... I'm Chisa. What shall we explore together, tidetamer?
                        </div>
                    </div>
                </div>
                
                <!-- Typing Indicator -->
                <div class="typing-indicator" id="typingIndicator">
                    <span></span>
                    <span></span>
                    <span></span>
                    <span>Chisa is thinking...</span>
                </div>
                
                <!-- Input Area -->
                <div class="input-area">
                    <input 
                        type="text" 
                        id="userInput" 
                        placeholder="Speak to Chisa... (e.g., Tell me a secret)"
                        autocomplete="off"
                    >
                    <button id="sendBtn">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                    <button id="micBtn" class="mic-btn">
                        <i class="fas fa-microphone"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Audio element for voice -->
    <audio id="notificationSound" preload="auto">
        <source src="data:audio/mpeg;base64,SUQzBAAAAAABEVRYWFgAAAAtAAADY29tbWVudABCaWdTb3VuZEJhbmsuY29tIC8gTG9uZWx5TWVkaWEuY29tIFNvdW5kIEVmZmVjdHM= Nothing" type="audio/mpeg">
    </audio>

    <script src="assets/avatar-states.js"></script>
    <script src="script.js"></script>
</body>
</html>* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Quicksand', sans-serif;
    overflow: hidden;
    height: 100vh;
    background: #0a0f1e;
}

/* Ocean animated background */
.ocean-bg {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: -1;
    background: linear-gradient(145deg, #0a1a2f 0%, #1b2b45 100%);
    overflow: hidden;
}

.wave {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 100px;
    background: rgba(100, 150, 255, 0.2);
    animation: waveMove 8s infinite linear;
}

.wave1 { bottom: 0; background: rgba(80, 140, 255, 0.15); animation-duration: 8s; }
.wave2 { bottom: 30px; background: rgba(120, 170, 255, 0.1); animation-duration: 12s; animation-direction: reverse; }
.wave3 { bottom: 60px; background: rgba(160, 200, 255, 0.05); animation-duration: 16s; }

@keyframes waveMove {
    0% { transform: translateX(0) translateY(0); }
    50% { transform: translateX(-25%) translateY(-10px); }
    100% { transform: translateX(-50%) translateY(0); }
}

.container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 20px;
    height: 100vh;
    display: flex;
    flex-direction: column;
}

/* Header */
header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 30px;
    background: rgba(10, 20, 40, 0.6);
    backdrop-filter: blur(10px);
    border-radius: 20px;
    border: 1px solid rgba(100, 150, 255, 0.3);
    margin-bottom: 20px;
}

.logo {
    display: flex;
    align-items: center;
    gap: 12px;
    color: white;
    font-size: 1.5rem;
    font-weight: 600;
}

.logo i {
    color: #7aa5ff;
    font-size: 2rem;
    animation: float 3s ease-in-out infinite;
}

@keyframes float {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-5px); }
}

.reset-btn {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(100, 150, 255, 0.5);
    color: white;
    padding: 10px 20px;
    border-radius: 30px;
    cursor: pointer;
    font-size: 1rem;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.3s;
}

.reset-btn:hover {
    background: rgba(100, 150, 255, 0.3);
    transform: scale(1.05);
}

/* Chat Interface */
.chat-interface {
    display: flex;
    gap: 30px;
    height: calc(100vh - 120px);
}

/* Avatar Section */
.avatar-section {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: rgba(20, 30, 50, 0.5);
    backdrop-filter: blur(10px);
    border-radius: 40px;
    border: 1px solid rgba(100, 150, 255, 0.2);
    padding: 20px;
}

.avatar-container {
    position: relative;
    width: 350px;
    height: 350px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.avatar-glow {
    position: absolute;
    width: 400px;
    height: 400px;
    border-radius: 50%;
    background: radial-gradient(circle, rgba(100, 150, 255, 0.3) 0%, transparent 70%);
    animation: glowPulse 3s ease-in-out infinite;
}

@keyframes glowPulse {
    0%, 100% { opacity: 0.5; transform: scale(1); }
    50% { opacity: 0.8; transform: scale(1.1); }
}

.avatar-frame {
    position: relative;
    width: 300px;
    height: 300px;
    border-radius: 50%;
    overflow: hidden;
    border: 4px solid rgba(255, 255, 255, 0.3);
    box-shadow: 0 0 50px rgba(100, 150, 255, 0.5);
    background: rgba(30, 40, 70, 0.5);
    transition: all 0.5s;
}

#avatarDisplay {
    width: 100%;
    height: 100%;
}

#avatarDisplay svg {
    width: 100%;
    height: 100%;
}

.emotion-badge {
    position: absolute;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(20, 30, 50, 0.8);
    backdrop-filter: blur(5px);
    padding: 8px 20px;
    border-radius: 30px;
    color: white;
    display: flex;
    align-items: center;
    gap: 8px;
    border: 1px solid rgba(255, 255, 255, 0.2);
    font-size: 0.9rem;
    text-transform: capitalize;
}

.speaking-indicator {
    position: absolute;
    top: -20px;
    right: 20px;
    display: flex;
    gap: 4px;
    opacity: 0;
    transition: opacity 0.3s;
}

.speaking-indicator.active {
    opacity: 1;
}

.speaking-indicator span {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #7aa5ff;
    animation: speakPulse 1s infinite;
}

.speaking-indicator span:nth-child(2) { animation-delay: 0.2s; }
.speaking-indicator span:nth-child(3) { animation-delay: 0.4s; }

@keyframes speakPulse {
    0%, 100% { transform: scale(1); opacity: 0.5; }
    50% { transform: scale(1.5); opacity: 1; }
}

.voice-status {
    position: absolute;
    bottom: -30px;
    left: 50%;
    transform: translateX(-50%);
    color: #aaddff;
    font-size: 0.8rem;
    display: flex;
    align-items: center;
    gap: 4px;
    white-space: nowrap;
}

.avatar-controls {
    margin-top: 60px;
    display: flex;
    gap: 15px;
}

.control-btn {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    border: none;
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(5px);
    color: white;
    font-size: 1.2rem;
    cursor: pointer;
    border: 1px solid rgba(255, 255, 255, 0.2);
    transition: all 0.3s;
}

.control-btn:hover {
    background: rgba(100, 150, 255, 0.3);
    transform: scale(1.1);
}

/* Chat Section */
.chat-section {
    flex: 2;
    display: flex;
    flex-direction: column;
    background: rgba(10, 20, 40, 0.6);
    backdrop-filter: blur(10px);
    border-radius: 40px;
    border: 1px solid rgba(100, 150, 255, 0.2);
    overflow: hidden;
}

.messages-container {
    flex: 1;
    padding: 30px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.message {
    display: flex;
    gap: 12px;
    max-width: 80%;
    animation: messageAppear 0.5s ease-out;
}

@keyframes messageAppear {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.message.user {
    align-self: flex-end;
    flex-direction: row-reverse;
}

.avatar-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: linear-gradient(145deg, #3a4a7a, #1f2a4a);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.2rem;
    flex-shrink: 0;
}

.message.user .avatar-icon {
    background: linear-gradient(145deg, #5a6a9a, #3a4a7a);
}

.bubble {
    padding: 15px 20px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 20px 20px 20px 5px;
    color: white;
    line-height: 1.6;
    border: 1px solid rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(5px);
}

.message.user .bubble {
    background: rgba(100, 150, 255, 0.2);
    border-radius: 20px 20px 5px 20px;
}

.typing-indicator {
    padding: 15px 30px;
    display: none;
    align-items: center;
    gap: 8px;
    color: #aaddff;
}

.typing-indicator.active {
    display: flex;
}

.typing-indicator span {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #7aa5ff;
    animation: typingBounce 1.4s infinite;
}

.typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
.typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

@keyframes typingBounce {
    0%, 60%, 100% { transform: translateY(0); }
    30% { transform: translateY(-10px); }
}

.input-area {
    padding: 30px;
    display: flex;
    gap: 15px;
    background: rgba(0, 0, 0, 0.2);
}

.input-area input {
    flex: 1;
    padding: 15px 25px;
    border: none;
    border-radius: 40px;
    background: rgba(255, 255, 255, 0.1);
    color: white;
    font-size: 1rem;
    font-family: inherit;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.input-area input:focus {
    outline: none;
    border-color: #7aa5ff;
    box-shadow: 0 0 15px rgba(122, 165, 255, 0.3);
}

.input-area input::placeholder {
    color: rgba(255, 255, 255, 0.5);
}

.input-area button {
    width: 55px;
    height: 55px;
    border-radius: 50%;
    background: linear-gradient(145deg, #5a6a9a, #3a4a7a);
    border: none;
    color: white;
    font-size: 1.2rem;
    cursor: pointer;
    transition: all 0.3s;
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.input-area button:hover {
    transform: scale(1.1);
    background: linear-gradient(145deg, #6a7aaa, #4a5a8a);
}

.mic-btn {
    background: linear-gradient(145deg, #4a5a8a, #2a3a6a) !important;
}// Frontend JavaScript for Chisa chatbot
document.addEventListener('DOMContentLoaded', () => {
    // DOM Elements
    const messagesContainer = document.getElementById('messagesContainer');
    const userInput = document.getElementById('userInput');
    const sendBtn = document.getElementById('sendBtn');
    const resetBtn = document.getElementById('resetBtn');
    const micBtn = document.getElementById('micBtn');
    const typingIndicator = document.getElementById('typingIndicator');
    const speakingIndicator = document.getElementById('speakingIndicator');
    const avatarDisplay = document.getElementById('avatarDisplay');
    const emotionBadge = document.getElementById('emotionBadge');
    const emotionText = document.getElementById('emotionText');
    const avatarGlow = document.getElementById('avatarGlow');
    const toggleVoiceBtn = document.getElementById('toggleVoiceBtn');
    const waveHandBtn = document.getElementById('waveHandBtn');
    const emoteBtn = document.getElementById('emoteBtn');
    const voiceStatus = document.getElementById('voiceStatus');

    // State
    let sessionId = 'session_' + Date.now();
    let voiceEnabled = true;
    let currentEmotion = 'happy';
    let mediaRecorder = null;
    let audioChunks = [];
    let isRecording = false;

    // Initialize avatar with default emotion
    updateAvatarEmotion('happy');

    // Event Listeners
    sendBtn.addEventListener('click', sendMessage);
    userInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendMessage();
    });
    resetBtn.addEventListener('click', resetConversation);
    micBtn.addEventListener('click', toggleVoiceRecording);
    toggleVoiceBtn.addEventListener('click', toggleVoice);
    waveHandBtn.addEventListener('click', waveHand);
    emoteBtn.addEventListener('click', cycleEmotion);

    // Functions
    async function sendMessage() {
        const message = userInput.value.trim();
        if (!message) return;

        // Add user message to UI
        addMessage(message, 'user');
        userInput.value = '';

        // Show typing indicator
        typingIndicator.classList.add('active');

        try {
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ message, sessionId })
            });

            const data = await response.json();
            
            // Hide typing indicator
            typingIndicator.classList.remove('active');
            
            // Add Chisa's response
            addMessage(data.response, 'chisa');
            
            // Update avatar emotion based on response
            if (data.emotion) {
                updateAvatarEmotion(data.emotion);
            }
            
            // Speak the response if voice is enabled
            if (voiceEnabled) {
                speakText(data.response);
            }

        } catch (error) {
            console.error('Error:', error);
            typingIndicator.classList.remove('active');
            addMessage('The waves are turbulent... Let\'s try again? ðŸŒŠ', 'chisa');
        }
    }

    function addMessage(text, sender) {
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('message', sender);
        
        const avatarIcon = document.createElement('div');
        avatarIcon.classList.add('avatar-icon');
        avatarIcon.innerHTML = sender === 'user' ? '<i class="fas fa-user"></i>' : '<i class="fas fa-ghost"></i>';
        
        const bubble = document.createElement('div');
        bubble.classList.add('bubble');
        bubble.textContent = text;
        
        messageDiv.appendChild(avatarIcon);
        messageDiv.appendChild(bubble);
        messagesContainer.appendChild(messageDiv);
        
        // Scroll to bottom
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    function updateAvatarEmotion(emotion) {
        currentEmotion = emotion;
        
        // Update emotion badge
        emotionText.textContent = emotion;
        
        // Update glow color based on emotion
        const colors = {
            happy: '#ffd966',
            playful: '#ffaa66',
            concerned: '#6699cc',
            curious: '#88ddff',
            calm: '#aaccff',
            grateful: '#ffaaff',
            neutral: '#c0a0ff'
        };
        
        avatarGlow.style.background = `radial-gradient(circle, ${colors[emotion] || colors.neutral} 0%, transparent 70%)`;
        
        // Update avatar SVG
        if (window.AVATAR_STATES && AVATAR_STATES[emotion]) {
            avatarDisplay.innerHTML = AVATAR_STATES[emotion].svg;
        }
    }

    function speakText(text) {
        if (!window.speechSynthesis) return;
        
        // Cancel any ongoing speech
        window.speechSynthesis.cancel();
        
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'en-US';
        utterance.pitch = 1.2;
        utterance.rate = 0.95;
        utterance.volume = 1;
        
        // Get a female voice if available
        const voices = window.speechSynthesis.getVoices();
        const femaleVoice = voices.find(v => v.name.includes('Female') || v.name.includes('Google UK'));
        if (femaleVoice) utterance.voice = femaleVoice;
        
        // Speaking indicator
        utterance.onstart = () => {
            speakingIndicator.classList.add('active');
            voiceStatus.innerHTML = '<i class="fas fa-volume-up"></i><span>Speaking...</span>';
        };
        
        utterance.onend = () => {
            speakingIndicator.classList.remove('active');
            voiceStatus.innerHTML = '<i class="fas fa-volume-up"></i><span>Voice Active</span>';
        };
        
        utterance.onerror = () => {
            speakingIndicator.classList.remove('active');
            voiceStatus.innerHTML = '<i class="fas fa-volume-up"></i><span>Voice Active</span>';
        };
        
        window.speechSynthesis.speak(utterance);
    }

    async function resetConversation() {
        try {
            await fetch('/api/reset', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ sessionId })
            });
            
            // Clear messages
            messagesContainer.innerHTML = '';
            addMessage('ðŸŒŠ The tides brought you to me... I\'m Chisa. What shall we explore together, tidetamer?', 'chisa');
            
            // Reset emotion
            updateAvatarEmotion('happy');
            
        } catch (error) {
            console.error('Error resetting conversation:', error);
        }
    }

    function toggleVoice() {
        voiceEnabled = !voiceEnabled;
        toggleVoiceBtn.innerHTML = voiceEnabled ? '<i class="fas fa-volume-up"></i>' : '<i class="fas fa-volume-mute"></i>';
        voiceStatus.innerHTML = voiceEnabled ? 
            '<i class="fas fa-volume-up"></i><span>Voice Active</span>' : 
            '<i class="fas fa-volume-mute"></i><span>Voice Muted</span>';
    }

    function waveHand() {
        // Simple animation for wave
        avatarDisplay.style.transform = 'rotate(10deg)';
        setTimeout(() => avatarDisplay.style.transform = 'rotate(0deg)', 300);
        
        // Add a playful message
        addMessage('*waves at you* ðŸ‘‹', 'chisa');
    }

    function cycleEmotion() {
        const emotions = ['happy', 'playful', 'curious', 'calm', 'grateful'];
        const currentIndex = emotions.indexOf(currentEmotion);
        const nextEmotion = emotions[(currentIndex + 1) % emotions.length];
        updateAvatarEmotion(nextEmotion);
    }

    // Voice recording (simplified)
    async function toggleVoiceRecording() {
        if (!isRecording) {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                
                mediaRecorder.ondataavailable = event => {
                    audioChunks.push(event.data);
                };
                
                mediaRecorder.onstop = async () => {
                    // In a real app, you'd send this to a speech-to-text service
                    // For now, we'll just simulate
                    addMessage('[Voice message received]', 'user');
                    setTimeout(() => {
                        addMessage('I heard the waves in your voice... What would you like to tell me? ðŸŒŠ', 'chisa');
                    }, 1000);
                };
                
                mediaRecorder.start();
                isRecording = true;
                micBtn.style.background = '#ff4444';
                
            } catch (error) {
                console.error('Microphone error:', error);
                alert('Could not access microphone');
            }
        } else {
            mediaRecorder.stop();
            mediaRecorder.stream.getTracks().forEach(track => track.stop());
            isRecording = false;
            micBtn.style.background = '';
        }
    }
});
